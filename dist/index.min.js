!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).lipgloss={})}(this,function(t){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function o(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t}function i(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var u=new(function(){function t(){n(this,t),this._order=[]}return o(t,[{key:"push",value:function(e){this._order=[e].concat(i(this._order.filter(function(t){return e.name!==t.name})))}},{key:"delete",value:function(e){this._order=this._order.filter(function(t){return e.name!==t.name})}},{key:"has",value:function(t){return this._order.includes(t)}},{key:"order",get:function(){return this._order}}]),t}()),a=new(function(){function t(){n(this,t),this._attributes={view:"data-view",slot:"data-view-slot",viewLink:"data-view-link",viewActive:"data-view-active",viewsLoading:"data-views-loading",viewsActive:"data-views-active",deactivateView:"data-deactivate-view",transition:"data-transition"}}return o(t,[{key:"assign",value:function(t){this._attributes=Object.assign(this._attributes,t)}},{key:"dict",get:function(){return this._attributes}}]),t}()),s=function(t,e,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};Array.from(t).forEach(function(t){return t.addEventListener(e,i,n)})},c=function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};t.dispatchEvent(new CustomEvent(e,{detail:i,bubbles:!0,cancelable:!0}))},l=function(t){return t.offsetHeight},d={list:function(t,e){var i=t.getAttribute(e)||"";return new Set(i.split(" ").filter(Boolean))},add:function(t,e,i){d.toggle(t,e,i,!0)},remove:function(t,e,i){d.toggle(t,e,i,!1)},has:function(t,e,i){return d.list(t,e).has(i)},toggle:function(t,e,i,n){var r=d.list(t,e);void 0===n&&(n=!r.has(i)),r[n?"add":"delete"](i),t.setAttribute(e,Array.from(r).join(" "))}};function h(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}}}function v(t,e,i){return i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var f=function(){function e(t){n(this,e),this._view=t}return o(e,[{key:"beforeExit",value:function(){return v()}},{key:"exit",value:h(function(){this._view.removeAttribute(a.dict.transition),l(this._view),this._view.setAttribute(a.dict.transition,"out")})},{key:"beforeEnter",value:function(){return v()}},{key:"enter",value:h(function(t,e){this.updateHtml(t),this._view.removeAttribute(a.dict.transition),l(this._view),this._view.setAttribute(a.dict.transition,"in")})},{key:"updateHtml",value:function(t){c(this._view,"viewhtmlwillupdate"),this._view.innerHTML=t.innerHTML,c(this._view,"viewhtmldidupdate")}},{key:"done",value:function(){this._view.removeAttribute(a.dict.transition),l(this._view)}},{key:"view",get:function(){return this._view}}]),e}();var _=0,w={},m=function(){function t(e){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this._request=new Request(e.url,i),this._doc=null,this._id="number"==typeof e.id?e.id:[Date.now(),_++].join("-"),(w[this._id]=this)._response=fetch(this._request).then(function(t){return t.ok?t:Promise.reject()}).then(function(t){return"error"!==i.redirect?t:e.url!==t.url?Promise.reject():t})}var i;return o(t,[{key:"includesView",value:(i=function(e){var t,i,n;return t=this.doc,i=function(t){return Boolean(t.querySelector("[".concat(a.dict.view,'="').concat(e,'"]')))},n?i?i(t):t:(t&&t.then||(t=Promise.resolve(t)),i?t.then(i):t)},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}})},{key:"equals",value:function(t){return!!t&&this.id===t.id}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=this._response.then(function(t){return t.text()}).then(function(t){return(new DOMParser).parseFromString(t,"text/html")})),this._doc}}],[{key:"getById",value:function(t){return w[t]}}]),t}();function y(t,e){if(!e)return t&&t.then?t.then(p):Promise.resolve()}function p(){}function e(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}}}function g(t,e,i){return i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var k=function(){function i(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(n(this,i),this._element=t,this._options=Object.assign(i.options,e),this.active=this.visible=!!this._element.innerHTML.trim(),this._model=this._options.model,this._selector="[".concat(a.dict.view,'="').concat(this._options.name,'"]'),this._transition=new this._options.transition(this._element),this.active&&u.push(this),!(this._transition instanceof f))throw new Error("Provided transition is not an instance of Transition")}return o(i,[{key:"setModel",value:e(function(i){var n=this;if(!i||!i.equals(n._model))return g(i.includesView(n._options.name),function(t){if(t)return c(n._element,"viewwillupdate"),g(i.doc,function(t){var e=t.querySelector(n._selector);return g(e&&Boolean(e.innerHTML.trim())?n._activate(i):n._deactivate(),function(t){n._transition.done(),c(n._element,"viewdidupdate")})})})})},{key:"_activate",value:e(function(t){var e,i,n=this;return n._model=t,n.loading=!0,t.doc.then(function(){return n.loading=!1}),e=function(){return g(t.doc,function(t){var e,i=t.querySelector(n._selector);if(!i)throw e=n.name,new Error("View '".concat(e,"' activated, but not found in the loaded document"));return Boolean(i.innerHTML.trim())?(u.has(n)||u.push(n),g(n._transition.beforeEnter(i,t),function(){return n.visible=!0,n.active=!0,y(n._enter(i,t))})):(n.active=!1,void(n.visible=!1))})},(i=function(){if(n.active)return g(n._transition.beforeExit(),function(){return y(n._exit())})}())&&i.then?i.then(e):e(i)})},{key:"_deactivate",value:e(function(){var t=this;if(t.active)return u.delete(t),g(t._transition.beforeExit(),function(){return t.active=!1,g(t._exit(),function(){t.visible=!1,t._model=null})})})},{key:"_enter",value:e(function(t,e){var i=this;return c(i._element,"viewwillenter"),g(i._transition.enter(t,e),function(){c(i._element,"viewdidenter")})})},{key:"_exit",value:e(function(){var t=this;return c(t._element,"viewwillexit"),g(t._transition.exit(),function(){c(t._element,"viewdidexit")})})},{key:"active",get:function(){return this._active},set:function(t){this._active!==t&&(this._active=t,this._element.setAttribute(a.dict.viewActive,t),d.toggle(document.body,"data-views-active",this.name,t))}},{key:"visible",set:function(t){this._visible!==t&&(this._visible=t,this._element.setAttribute(a.dict.viewActive,t),d.toggle(document.body,"data-views-visible",this.name,t))}},{key:"loading",get:function(){return this._isLoading},set:function(t){this._isLoading!==t&&(this._isLoading=t,d.toggle(document.body,a.dict.viewsLoading,this.name,t))}},{key:"name",get:function(){return this._options.name}},{key:"transition",get:function(){return this._transition}},{key:"model",get:function(){return this._model}}],[{key:"options",get:function(){return{name:null,transition:f,model:null}}}]),i}();function b(){}function A(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}}}var P="pushState"in history,q=new(function(){function i(){n(this,i)}return o(i,[{key:"init",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(P){this._options=Object.assign({},i.options,t),this._viewsMap=new WeakMap,this._views=[],a.assign(this._options.attributes);var e=this._options.sanitizeUrl(window.location.href);this._model=new m({url:e},this._options.fetch),this._queuedModel=this._model,this._updatingPage=!1,this._onLinkClick=this._onLinkClick.bind(this),this._onDeactivateViewClick=this._onDeactivateViewClick.bind(this),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document),c(window,"lipglossready")}}},{key:"isActive",value:function(t){var e=this._getViewByName(t);return e&&e.active}},{key:"_bindEvents",value:function(){var e=this;document.addEventListener("viewdidenter",function(t){return e.initializeContext(t.target)}),window.addEventListener("popstate",function(t){return e._onPopState(t)})}},{key:"initializeContext",value:function(t){var i=this,e="[".concat(a.dict.view,"], [").concat(a.dict.slot,"]");Array.from(t.querySelectorAll(e)).filter(function(t){return!i._viewsMap.has(t)}).forEach(function(t){var e=i._createView(t,i._model);i._viewsMap.set(t,e),i._views.push(e)}),s(t.querySelectorAll("[href][".concat(a.dict.viewLink,"]")),"click",this._onLinkClick),s(t.querySelectorAll("[".concat(a.dict.deactivateView,"]")),"click",this._onDeactivateViewClick)}},{key:"_createView",value:function(t,e){var i=t.getAttribute(a.dict.view)||t.getAttribute(a.dict.slot),n=this._options.transitions[i]||f;return new k(t,{name:i,transition:n,model:e})}},{key:"_onLinkClick",value:A(function(t){t.preventDefault();var e=this._options.sanitizeUrl(t.currentTarget.href);this.openUrl(e)})},{key:"openUrl",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this._options.fetch,i=new m({url:t},e),n=this._model&&this._model.equals(i);this._queueModel(i),this._addHistoryEntry(i,n)}},{key:"_onDeactivateViewClick",value:function(t){t.preventDefault();var e=t.currentTarget.getAttribute(a.dict.deactivateView);this.deactivateView(e)}},{key:"deactivateView",value:function(t){var e=this._getViewByName(t),i=u.order.find(function(t){return!t.model.equals(e.model)});if(!i)throw new Error("Unable to deactivate view ".concat(t,", because there's no view to fall back to."));this._queueModel(i.model),this._addHistoryEntry(i.model)}},{key:"_getViewByName",value:function(e){return this._views.find(function(t){return t.name===e})}},{key:"_onPopState",value:function(t){if(t.state)try{var e=m.getById(t.state.modelId);if(!e){var i={url:t.state.url,id:t.state.modelId};e=new m(i,this._options.fetch)}this._queueModel(e)}catch(t){console.error(t),window.location.href=model.url}}},{key:"_queueModel",value:function(t){this._queuedModel=t,this._updatingPage||this._setModel(t)}},{key:"_setModel",value:A(function(n){var t,e,r=this;return r._model=n,r._updatingPage=!0,t=function(t,e){try{var i=t()}catch(t){return e(t)}return i&&i.then?i.then(void 0,e):i}(function(){return c(window,"pagewillupdate"),r._views.forEach(A(function(t){return function(t,e){if(!e)return t&&t.then?t.then(b):Promise.resolve()}(t.setModel(n))})),t=n.doc,e=function(t){r._options.updateDocument(t),r._views=r._views.filter(function(t){return Boolean(document.querySelector((e=t.name,"\n  [".concat(a.dict.view,"=").concat(e,"],\n  [").concat(a.dict.slot,"=").concat(e,"]\n"))));var e}),c(window,"pagedidupdate")},i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t);var t,e,i},function(t){console.error(t),window.location.href=n.url}),e=function(){r._updatingPage=!1,r._queuedModel!==n&&r._setModel(r._queuedModel)},t&&t.then?t.then(e):e(t)})},{key:"_addHistoryEntry",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i={title:document.title,url:t.url,model:t.id};history[e?"replaceState":"pushState"](i,document.title,t.url),c(window,"statechange",i)}}],[{key:"options",get:function(){return{transitions:{},sanitizeUrl:function(t){return t},updateDocument:function(t){document.title=t.title},attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),i}());t.View=k,t.Model=m,t.Transition=f,t.Attributes=a,t.default=q,Object.defineProperty(t,"__esModule",{value:!0})});
