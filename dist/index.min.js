!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.lipgloss={})}(this,function(t){"use strict";var e=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{bubbles:!0,cancelable:!0};t.dispatchEvent(new CustomEvent(e,i))},i=function(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){return function n(r,a){try{var o=e[r](a),s=o.value}catch(t){return void i(t)}if(!o.done)return Promise.resolve(s).then(function(t){n("next",t)},function(t){n("throw",t)});t(s)}("next")})}},n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),a=new(function(){function t(){n(this,t),this._attributes=t.defaultAttributes}return r(t,[{key:"overrideAttributes",value:function(e){this._attributes=Object.assign(t.defaultAttributes,e)}},{key:"attribute",value:function(t){return this._attributes[t]}}],[{key:"defaultAttributes",get:function(){return{"data-view-link":"data-view-link","data-view-link-active":"data-active","data-view-hint":"data-view-hint","data-view":"data-view","data-view-active":"data-view-active","data-activate-view":"data-activate-view","data-views-loading":"data-views-loading","data-persist-view":"data-persist-view","data-transition":"data-transition"}}}]),t}()),o=function(t){return a.attribute(t)},s=function(t){return t.offsetHeight},u=function(){function t(e){n(this,t),this._view=e,this._,name=e.getAttribute(o("data-view")),this._eventOptions={bubbles:!0,cancelable:!0,detail:{name:this._name}}}return r(t,[{key:"exit",value:(c=i(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e(this._view,"viewwillexit",this._eventOptions),this._view.removeAttribute(o("data-transition")),s(this._view),this._view.setAttribute(o("data-transition"),"out");case 4:case"end":return t.stop()}},t,this)})),function(){return c.apply(this,arguments)})},{key:"loading",value:(u=i(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this._view.removeAttribute(o("data-transition")),s(this._view),this._view.setAttribute(o("data-transition"),"loading");case 3:case"end":return t.stop()}},t,this)})),function(){return u.apply(this,arguments)})},{key:"enter",value:(a=i(regeneratorRuntime.mark(function t(i){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e(this._view,"viewwillupdate",this._eventOptions),this._view.innerHTML=i.innerHTML,e(this._view,"viewupdated",this._eventOptions),this._view.removeAttribute(o("data-transition")),s(this._view),this._view.setAttribute(o("data-transition"),"in");case 6:case"end":return t.stop()}},t,this)})),function(t){return a.apply(this,arguments)})}]),t;var a,u,c}(),c=function(t){return a.attribute(t)},h=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this._element=e,this._options=Object.assign(t.options,i),this.active=!!this._element.innerHTML,this._persist=this._element.hasAttribute(c("data-persist-view")),this._activeModel=this._options.model;var r=this._options.transition;if(this._transition=new r(this._element),!(this._transition instanceof u))throw Error("Provided transition is not an instance of Transition")}return r(t,[{key:"hasName",value:function(t){return this._options.name===t}},{key:"_activate",value:(a=i(regeneratorRuntime.mark(function t(e){var i,n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!this._activeModel||this._activeModel.url!==e.url){t.next=3;break}return this.active=!0,t.abrupt("return");case 3:if(this.loading=!0,e.doc.then(function(){n.loading=!1}),t.t0=this.active,!t.t0){t.next=9;break}return t.next=9,this._transition.exit();case 9:return this.loading&&this._transition.loading(),t.next=12,e.querySelector(this.selector);case 12:return i=t.sent,this._activeModel=e,t.next=16,this._transition.enter(i);case 16:this.active=!0;case 17:case"end":return t.stop()}},t,this)})),function(t){return a.apply(this,arguments)})},{key:"_deactivate",value:(e=i(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.active){t.next=2;break}return t.abrupt("return");case 2:if(this._persist){t.next=6;break}return this._activeModel=null,t.next=6,this._transition.exit(this._element);case 6:this.active=!1;case 7:case"end":return t.stop()}},t,this)})),function(){return e.apply(this,arguments)})},{key:"selector",get:function(){return this._options.selector||"["+c("data-view")+'="'+this._options.name+'"]'}},{key:"active",get:function(){return this._active},set:function(t){this._active=t,this._element.setAttribute(c("data-view-active"),t)}},{key:"loading",get:function(){return this._isLoading},set:function(t){var e=this;this._isLoading=t;var i,n=document.body.hasAttribute(c("data-views-loading"))?document.body.getAttribute(c("data-views-loading")).split(" ")||[]:[],r=t?(i=[].concat(function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(n),[this._options.name]),Array.from(new Set(i))):n.filter(function(t){return t!==e._options.name});document.body.setAttribute(c("data-views-loading"),r.join(" "))}},{key:"model",get:function(){return this._activeModel},set:function(t){var e=this;(t.includesView(this._options.name)?Promise.resolve():t.querySelector(this.selector)).then(function(){return e._activate(t)},function(){return e._deactivate()})}}],[{key:"options",get:function(){return{name:null,persist:!1,transition:u,selector:null,model:null}}}]),t;var e,a}(),l=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];n(this,t),this._request=e,this._hints=i,this._doc=null}return r(t,[{key:"includesView",value:function(t){return this._hints.includes(t)}},{key:"querySelector",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"body";return this.doc.then(function(e){return e.querySelector(t)}).then(function(t){return t&&t.innerHTML?t:Promise.reject()})}},{key:"getRepresentation",value:function(){return{url:this._request.url,hints:this._hints}}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=fetch(this._request).then(function(t){return t.ok?t:Promise.reject()}).then(function(t){return t.text()}).then(function(t){return(new DOMParser).parseFromString(t,"text/html")})),this._doc}}],[{key:"create",value:function(e){var i=e.url,n=e.hints,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new t(new Request(i,r),n||[])}}]),t}(),d="pushState"in history,v=function(t){return a.attribute(t)},f=new(function(){function t(){n(this,t)}return r(t,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(d){if(this._initialized)throw Error("You can only initialize Lipgloss once.");this._initialized=!0,this._options=Object.assign(t.options,e),this._viewsMap=new WeakMap,this._options.overrideAttributes&&a.overrideAttributes(this._options.overrideAttributes);var i=this._options.sanitizeUrl(window.location.href);this._model=l.create({url:i,hints:[]},this._options.fetch),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document)}}},{key:"_bindEvents",value:function(){var t=this;this._onLinkClick=this._onLinkClick.bind(this),this._onActivateViewClick=this._onActivateViewClick.bind(this),document.addEventListener("viewupdated",function(e){return t.initializeContext(e.target)}),window.addEventListener("popstate",function(e){return t._onPopState(e)})}},{key:"initializeContext",value:function(t){var e=this;Array.from(t.querySelectorAll("["+v("data-view")+"]")).filter(function(t){return!e._viewsMap.has(t)}).forEach(function(t){return e._viewsMap.set(t,e._buildView(t,e._model))}),t.querySelectorAll("[href]["+v("data-view-link")+"]").forEach(function(t){return t.addEventListener("click",e._onLinkClick)}),t.querySelectorAll("["+v("data-activate-view")+"]").forEach(function(t){return t.addEventListener("click",e._onActivateViewClick)})}},{key:"_buildView",value:function(t,e){var i=t.getAttribute(v("data-view")),n=t.hasAttribute(v("data-persist-view")),r=this._options.transitions[i]||u;return new h(t,{name:i,transition:r,persist:n,model:e})}},{key:"_throwOnUnknownViewsWithoutParent",value:function(t){var e=this,i=Array.from(t.querySelectorAll("["+v("data-view")+"]")).filter(function(t){var i=t.getAttribute(v("data-view"));return!e.views.some(function(t){return t.hasName(i)})}).find(function(t){return!t.parentNode.closest("["+v("data-view")+"]")});if(i){var n=i.getAttribute(v("data-view"));throw Error("Not able to determine where ["+v("data-view")+"='"+n+"'] should be inserted.")}}},{key:"_isCurrentUrl",value:function(t){return this._options.sanitizeUrl(t)===this._options.sanitizeUrl(window.location.href)}},{key:"_onLinkClick",value:(c=i(regeneratorRuntime.mark(function t(e){var i,n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.preventDefault(),i=this._options.sanitizeUrl(e.currentTarget.href),n=e.currentTarget.hasAttribute(v("data-view-hint"))?e.currentTarget.getAttribute(v("data-view-hint")).split(","):this._options.defaultHints,r=l.create({url:i,hints:n},this._options.fetch),!this._isCurrentUrl(r.url)){t.next=6;break}return t.abrupt("return");case 6:return t.next=8,this._updatePage(r);case 8:this._addHistoryEntry(r);case 9:case"end":return t.stop()}},t,this)})),function(t){return c.apply(this,arguments)})},{key:"_onActivateViewClick",value:(s=i(regeneratorRuntime.mark(function t(e){var i,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.preventDefault(),i=e.currentTarget.getAttribute(v("data-activate-view")),n=this._getModelFromView(i),!this._isCurrentUrl(n.url)){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,this._updatePage(n);case 7:this._addHistoryEntry(n);case 8:case"end":return t.stop()}},t,this)})),function(t){return s.apply(this,arguments)})},{key:"_getModelFromView",value:function(t){var e=document.querySelector("["+v("data-view")+'="'+t+'"]');return this._viewsMap.get(e).model}},{key:"_onPopState",value:function(t){if(t.state&&t.state.model){var e=l.create(t.state.model,this._options.fetch);this._updatePage(e)}}},{key:"_updatePage",value:(o=i(regeneratorRuntime.mark(function t(e){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this._model=e,t.prev=1,this.views.forEach(function(t){return t.model=e}),t.next=5,e.doc;case 5:i=t.sent,this._throwOnUnknownViewsWithoutParent(i),document.title=i.title,t.next=13;break;case 10:t.prev=10,t.t0=t.catch(1),window.location.href=e.url;case 13:case"end":return t.stop()}},t,this,[[1,10]])})),function(t){return o.apply(this,arguments)})},{key:"_addHistoryEntry",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={title:document.title,url:t.url,model:t.getRepresentation()};i?window.history.replaceState(n,document.title,t.url):window.history.pushState(n,document.title,t.url),e(window,"statechange",{detail:n})}},{key:"views",get:function(){var t=this;return Array.from(document.querySelectorAll("["+v("data-view")+"]")).map(function(e){return t._viewsMap.get(e)})}}],[{key:"options",get:function(){return{defaultHints:[],transitions:{},sanitizeUrl:function(t){return t},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),t;var o,s,c}());t.View=h,t.Model=l,t.Transition=u,t.default=f,Object.defineProperty(t,"__esModule",{value:!0})});
