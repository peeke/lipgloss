!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.lipgloss={})}(this,function(t){"use strict";var e=new class{constructor(){this._overrides={}}assign(t){this._overrides=Object.assign(this._overrides,t)}attribute(t){return this._overrides[t]||t}};const i=t=>e.attribute(t),s=t=>t.offsetHeight;class n{constructor(t){this._view=t}async exit(){this._view.removeAttribute(i("data-transition")),s(this._view),this._view.setAttribute(i("data-transition"),"out")}async loading(){this._view.removeAttribute(i("data-transition")),s(this._view),this._view.setAttribute(i("data-transition"),"loading")}async enter(t){this._view.innerHTML=t.innerHTML,this._view.removeAttribute(i("data-transition")),s(this._view),this._view.setAttribute(i("data-transition"),"in")}}const r=(t,e,i={bubbles:!0,cancelable:!0})=>{t.dispatchEvent(new CustomEvent(e,i))},a=t=>Array.from(new Set(t)),o=t=>e.attribute(t);class h{constructor(t,e={}){this._element=t,this._options=Object.assign(h.options,e),this.active=!!this._element.innerHTML,this._persist=this._element.hasAttribute(o("data-persist-view")),this._activeModel=this._options.model;const i=this._options.transition;if(this._transition=new i(this._element),!(this._transition instanceof n))throw Error("Provided transition is not an instance of Transition")}static get options(){return{name:null,persist:!1,transition:n,selector:null,model:null}}get eventOptions(){return{bubbles:!0,cancelable:!0,detail:{name:this._name}}}get selector(){return this._options.selector||`[${o("data-view")}="${this._options.name}"]`}get active(){return this._active}set active(t){this._active=t,this._element.setAttribute(o("data-view-active"),t)}get loading(){return this._isLoading}set loading(t){this._isLoading=t;const e=document.body.hasAttribute(o("data-views-loading"))?document.body.getAttribute(o("data-views-loading")).split(" "):[],i=t?a([...e,this._options.name]):e.filter(t=>t!==this._options.name);document.body.setAttribute(o("data-views-loading"),i.join(" "))}get model(){return this._activeModel}set model(t){this._setModel(t)}async setModel(t){const e=t.includesView(this._options.name),i=Promise.resolve(e||t.querySelector(this.selector)),s=await i.then(()=>!0,()=>!1);await s?this._activate(t):this._deactivate(),this.active=s}get name(){return this._options.name}async _activate(t){this._activeModel&&this._activeModel.url===t.url||(this.loading=!0,t.doc.then(()=>{this.loading=!1}),this.active&&await this._exit(),this.loading&&this._transition.loading(),await this._enter(await t.querySelector(this.selector)),this._activeModel=t)}async _deactivate(){this.active&&(this._persist||(await this._exit(),this._activeModel=null))}async _enter(t){r(this._element,"viewwillenter",this.eventOptions),await this._transition.enter(t),r(this._element,"viewdidenter",this.eventOptions)}async _exit(){r(this._element,"viewwillexit",this.eventOptions),await this._transition.exit(),r(this._element,"viewdidexit",this.eventOptions)}}class l{constructor(t,e){this._request=new Request(t.url,e),this._hints=t.hints||[],this._doc=null}get url(){return this._request.url}get doc(){return this._doc||(this._doc=fetch(this._request).then(t=>t.ok?t:Promise.reject()).then(t=>t.text()).then(t=>(new DOMParser).parseFromString(t,"text/html"))),this._doc}includesView(t){return this._hints.includes(t)}querySelector(t="body"){return this.doc.then(e=>e.querySelector(t)).then(t=>t&&t.innerHTML?t:Promise.reject())}getRepresentation(){return{url:this._request.url,hints:this._hints}}}const c="pushState"in history,d=t=>e.attribute(t);class u{init(t={}){if(!c)return;if(this._initialized)throw Error("You can only initialize Lipgloss once.");this._initialized=!0,this._options=Object.assign(u.options,t),this._viewsMap=new WeakMap,e.assign(this._options.attributes);const i=this._options.sanitizeUrl(window.location.href);this._model=new l({url:i,hints:[]},this._options.fetch),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document)}static get options(){return{defaultHints:[],transitions:{},sanitizeUrl:t=>t,attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}get views(){return Array.from(document.querySelectorAll(`[${d("data-view")}]`)).map(t=>this._viewsMap.get(t))}_bindEvents(){this._onLinkClick=this._onLinkClick.bind(this),this._onActivateViewClick=this._onActivateViewClick.bind(this),document.addEventListener("viewdidenter",t=>this.initializeContext(t.target)),window.addEventListener("popstate",t=>this._onPopState(t))}initializeContext(t){Array.from(t.querySelectorAll(`[${d("data-view")}]`)).filter(t=>!this._viewsMap.has(t)).forEach(t=>this._viewsMap.set(t,this._buildView(t,this._model))),t.querySelectorAll(`[href][${d("data-view-link")}]`).forEach(t=>t.addEventListener("click",this._onLinkClick)),t.querySelectorAll(`[${d("data-activate-view")}]`).forEach(t=>t.addEventListener("click",this._onActivateViewClick))}_buildView(t,e){const i=t.getAttribute(d("data-view")),s=t.hasAttribute(d("data-persist-view")),r=this._options.transitions[i]||n;return new h(t,{name:i,transition:r,persist:s,model:e})}_throwOnUnknownViews(t){const e=t=>`Not able to determine where [${d("data-view")}='${t}'] should be inserted.`;Array.from(t.querySelectorAll(`[${d("data-view")}]`)).map(t=>t.getAttribute(d("data-view"))).filter(t=>!this.views.some(e=>e.name===t)).forEach(t=>{throw Error(e(t))})}_isCurrentUrl(t){return this._options.sanitizeUrl(t)===this._options.sanitizeUrl(window.location.href)}async _onLinkClick(t){t.preventDefault();const e=this._options.sanitizeUrl(t.currentTarget.href),i=t.currentTarget.getAttribute(d("data-view-link")),s=i?i.split(","):this._options.defaultHints,n=new l({url:e,hints:s},this._options.fetch);this._isCurrentUrl(n.url)||(await this._updatePage(n),this._addHistoryEntry(n))}async _onActivateViewClick(t){t.preventDefault();const e=t.currentTarget.getAttribute(d("data-activate-view")),i=this._getModelFromView(e);this._isCurrentUrl(i.url)||(await this._updatePage(i),this._addHistoryEntry(i))}_getModelFromView(t){const e=document.querySelector(`[${d("data-view")}="${t}"]`),i=this._viewsMap.get(e);return i.model}_onPopState(t){try{const e=new l(t.state.model,this._options.fetch);this._updatePage(e)}catch(t){}}async _updatePage(t){this._model=t;try{const e=this.views.map(e=>e.setModel(t));await Promise.all(e);const i=await t.doc;this._throwOnUnknownViews(i),document.title=i.title}catch(e){window.location.href=t.url}}_addHistoryEntry(t,e=!1){const i={title:document.title,url:t.url,model:t.getRepresentation()},s=e?"replaceState":"pushState";history[s](i,document.title,t.url),r(window,"statechange",{detail:i})}}var _=new u;t.View=h,t.Model=l,t.Transition=n,t.default=_,Object.defineProperty(t,"__esModule",{value:!0})});
