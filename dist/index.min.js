!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).lipgloss={})}(this,function(t){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function u(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function i(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var a=new(function(){function t(){o(this,t),this._order=[]}return u(t,[{key:"push",value:function(e){this._order=[e].concat(i(this._order.filter(function(t){return e.name!==t.name})))}},{key:"delete",value:function(e){this._order=this._order.filter(function(t){return e.name!==t.name})}},{key:"has",value:function(t){return this._order.includes(t)}},{key:"order",get:function(){return this._order}}]),t}()),s=new(function(){function t(){o(this,t),this._attributes={view:"data-view",slot:"data-view-slot",viewLink:"data-view-link",viewActive:"data-view-active",viewsLoading:"data-views-loading",viewsActive:"data-views-active",deactivateView:"data-deactivate-view",transition:"data-transition"}}return u(t,[{key:"assign",value:function(t){this._attributes=Object.assign(this._attributes,t)}},{key:"dict",get:function(){return this._attributes}}]),t}()),r=function(t,e,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};Array.from(t).forEach(function(t){return t.addEventListener(e,i,n)})},c=function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};t.dispatchEvent(new CustomEvent(e,{detail:i,bubbles:!0,cancelable:!0}))},l=function(t){return t.offsetHeight};function d(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}}}function h(t,e,i){return i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var v=function(){function e(t){o(this,e),this._view=t}return u(e,[{key:"beforeExit",value:function(){return h()}},{key:"exit",value:d(function(){this._view.removeAttribute(s.dict.transition),l(this._view),this._view.setAttribute(s.dict.transition,"out")})},{key:"loading",value:d(function(){this._view.removeAttribute(s.dict.transition),l(this._view),this._view.setAttribute(s.dict.transition,"loading")})},{key:"beforeEnter",value:function(){return h()}},{key:"enter",value:d(function(t,e){this.updateHtml(t),this._view.removeAttribute(s.dict.transition),l(this._view),this._view.setAttribute(s.dict.transition,"in")})},{key:"updateHtml",value:function(t){c(this._view,"viewhtmlwillupdate"),this._view.innerHTML=t.innerHTML,c(this._view,"viewhtmldidupdate")}},{key:"done",value:function(){this._view.removeAttribute(s.dict.transition),l(this._view)}},{key:"view",get:function(){return this._view}}]),e}();var f=0,_={},w=function(){function r(e){var t,i=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};o(this,r),this._request=new Request(e.url,n),this._hints=e.hints||[],this._doc=null,this._id=(t=e.id,Number(t)===t?e.id:[Date.now(),f++].join("-")),_[this._id]=this,c(window,"modelload"),this._response=fetch(this._request).then(function(t){return t.ok?t:Promise.reject()}).then(function(t){return"error"!==n.redirect?t:e.url!==t.url?Promise.reject():t}),this._response.then(function(){return c(window,"modelloaded",i.getBlueprint())})}var i;return u(r,[{key:"hasHint",value:function(t){return this._hints.includes(t)}},{key:"includesView",value:(i=function(e){var t,i,n;return t=this.doc,i=function(t){return Boolean(t.querySelector("[".concat(s.dict.view,'="').concat(e,'"]')))},n?i?i(t):t:(t&&t.then||(t=Promise.resolve(t)),i?t.then(i):t)},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}})},{key:"equals",value:function(t){return!!t&&(this===t||this.id===t.id)}},{key:"getBlueprint",value:function(){return{id:this._id,url:this._request.url,hints:this._hints}}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=this._response.then(function(t){return t.text()}).then(function(t){return(new DOMParser).parseFromString(t,"text/html")})),this._doc}}],[{key:"getById",value:function(t){return _[t]}}]),r}(),m=function(){function i(t,e){o(this,i),this._element=t,this._attribute=e}return u(i,[{key:"_getList",value:function(){var t=this._element.getAttribute(this._attribute)||"";return new Set(t.split(" ").filter(Boolean))}},{key:"add",value:function(t){this.toggle(t,!0)}},{key:"remove",value:function(t){this.toggle(t,!1)}},{key:"has",value:function(t){return this._getList().has(t)}},{key:"toggle",value:function(t,e){var i=this._getList();void 0===e&&(e=!i.has(t)),i[e?"add":"delete"](t),this._element.setAttribute(this._attribute,Array.from(i).join(" "))}}]),i}();function e(t,e){if(!e)return t&&t.then?t.then(y):Promise.resolve()}function y(){}function g(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}}}function p(t,e){var i=t();return i&&i.then?i.then(e):e(i)}function k(t,e,i){return i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var b=function(){function i(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(o(this,i),this._element=t,this._options=Object.assign(i.options,e),this._loadingList=new m(document.body,s.dict.viewsLoading),this._activeList=new m(document.body,s.dict.viewsActive),this._visibleList=new m(document.body,"data-views-visible"),this.active=this.visible=!!this._element.innerHTML.trim(),this._model=this._options.model,this._selector="[".concat(s.dict.view,'="').concat(this._options.name,'"]'),this._transition=new this._options.transition(this._element),this.active&&a.push(this),!(this._transition instanceof v))throw new Error("Provided transition is not an instance of Transition")}return u(i,[{key:"setModel",value:g(function(i){var n=this;if(!i||!i.equals(n._model)){var r=i.hasHint(n._options.name);return k(r||i.includesView(n._options.name),function(t){var e=!1;if(t)return p(function(){if(r)return k(n._activate(i),function(){n._transition.done(),e=!0})},function(t){return e?t:k(i.doc,function(t){var e=t.querySelector(n._selector);return k(e&&Boolean(e.innerHTML.trim())?n._activate(i):n._deactivate(),function(){n._transition.done()})})});n._transition.done()},r)}n._transition.done()})},{key:"_activate",value:g(function(n){var r=this;return r.loading=!0,n.doc.then(function(){return r.loading=!1}),p(function(){if(r.active)return k(r._transition.beforeExit(),function(){return e(r._exit())})},function(){return p(function(){if(r.loading)return e(r._transition.loading())},function(){return k(n.doc,function(t){var e,i=t.querySelector(r._selector);if(!i)throw e=r.name,new Error("View '".concat(e,"' activated, but not found in the loaded document (maybe you've provided it as a hint?)."));return Boolean(i.innerHTML.trim())?(a.has(r)||a.push(r),k(r._transition.beforeEnter(i,t),function(){return r.visible=!0,r.active=!0,k(r._enter(i,t),function(){r._model=n})})):(r.active=!1,void(r.visible=!1))})})})})},{key:"_deactivate",value:g(function(){var t=this;if(t.active)return a.delete(t),k(t._transition.beforeExit(),function(){return t.active=!1,k(t._exit(),function(){t.visible=!1,t._model=null})})})},{key:"_enter",value:g(function(t,e){var i=this;return c(i._element,"viewwillenter"),k(i._transition.enter(t,e),function(){c(i._element,"viewdidenter")})})},{key:"_exit",value:g(function(){var t=this;return c(t._element,"viewwillexit"),k(t._transition.exit(),function(){c(t._element,"viewdidexit")})})},{key:"active",get:function(){return this._active},set:function(t){this._active!==t&&(this._active=t,this._element.setAttribute(s.dict.viewActive,t),this._activeList.toggle(this._options.name,t))}},{key:"visible",set:function(t){this._visible!==t&&(this._visible=t,this._element.setAttribute(s.dict.viewActive,t),this._visibleList.toggle(this._options.name,t))}},{key:"loading",get:function(){return this._isLoading},set:function(t){this._isLoading!==t&&(this._isLoading=t,this._loadingList.toggle(this._options.name,t))}},{key:"model",get:function(){return this._model}},{key:"name",get:function(){return this._options.name}},{key:"transition",get:function(){return this._transition}}],[{key:"options",get:function(){return{name:null,transition:v,model:null}}}]),i}();function A(t,e,i){return i?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}function P(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(i.apply(this,t))}catch(t){return Promise.reject(t)}}}var L="pushState"in history,q=new(function(){function i(){o(this,i)}return u(i,[{key:"init",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(L){this._options=Object.assign({},i.options,t),this._viewsMap=new WeakMap,s.assign(this._options.attributes);var e=this._options.sanitizeUrl(window.location.href);this._model=new w({url:e,hints:this._options.defaultHints},this._options.fetch),this._queuedModel=this._model,this._updatingPage=!1,this._onLinkClick=this._onLinkClick.bind(this),this._onDeactivateViewClick=this._onDeactivateViewClick.bind(this),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document),c(window,"lipglossready")}}},{key:"_gatherViews",value:function(){var e=this,t="[".concat(s.dict.view,"], [").concat(s.dict.slot,"]");return Array.from(document.querySelectorAll(t)).map(function(t){return e._viewsMap.get(t)})}},{key:"isActive",value:function(t){var e=this._getViewByName(t);return e&&e.active}},{key:"_bindEvents",value:function(){var e=this;document.addEventListener("viewdidenter",function(t){return e.initializeContext(t.target)}),window.addEventListener("popstate",function(t){return e._onPopState(t)})}},{key:"initializeContext",value:function(t){var e=this,i="[".concat(s.dict.view,"], [").concat(s.dict.slot,"]");Array.from(t.querySelectorAll(i)).filter(function(t){return!e._viewsMap.has(t)}).forEach(function(t){return e._viewsMap.set(t,e._createView(t,e._model))}),r(t.querySelectorAll("[href][".concat(s.dict.viewLink,"]")),"click",this._onLinkClick),r(t.querySelectorAll("[".concat(s.dict.deactivateView,"]")),"click",this._onDeactivateViewClick)}},{key:"_createView",value:function(t,e){var i=t.getAttribute(s.dict.view)||t.getAttribute(s.dict.slot),n=this._options.transitions[i]||v;return new b(t,{name:i,transition:n,model:e})}},{key:"_throwOnUnknownViews",value:function(t){var i=this._gatherViews();Array.from(t.querySelectorAll("[".concat(s.dict.view,"]"))).map(function(t){return t.getAttribute(s.dict.view)}).filter(function(e){return!i.some(function(t){return t.name===e})}).forEach(function(t){throw new Error((e=t,"Not able to determine where [".concat(s.dict.view,"='").concat(e,"'] should be inserted.")));var e})}},{key:"_onLinkClick",value:P(function(t){t.preventDefault();var e=this._options.sanitizeUrl(t.currentTarget.href),i=t.currentTarget.getAttribute(s.dict.viewLink),n=i?i.split(","):this._options.defaultHints;this.openUrl(e,n)})},{key:"openUrl",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this._options.defaultHints,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this._options.fetch;e=Array.isArray(e)?e:[e];var n=new w({url:t,hints:e},i),r=this._model&&this._model.equals(n);this._queuePageUpdate(n),this._addHistoryEntry(n,r)}},{key:"_onDeactivateViewClick",value:function(t){t.preventDefault();var e=t.currentTarget.getAttribute(s.dict.deactivateView);this.deactivateView(e)}},{key:"deactivateView",value:function(t){var e=this._getViewByName(t),i=a.order.find(function(t){return!t.model.equals(e.model)});if(!i)throw new Error("Unable to deactivate view ".concat(t,", because there's no view to fall back to."));this._queuePageUpdate(i.model),this._addHistoryEntry(i.model)}},{key:"_getViewByName",value:function(t){var e=document.querySelector("[".concat(s.dict.view,'="').concat(t,'"], [').concat(s.dict.slot,'="').concat(t,'"]'));return this._viewsMap.get(e)}},{key:"_onPopState",value:function(t){if(t.state)try{var e=w.getById(t.state.model.id)||new w(t.state.model,this._options.fetch);this._queuePageUpdate(e)}catch(t){console.error(t),window.location.href=model.url}}},{key:"_queuePageUpdate",value:function(t){this._queuedModel=t,this._updatingPage||this._updatePage(t)}},{key:"_updatePage",value:P(function(i){var t,e,n=this;return n._updatingPage=!0,c(window,"pagewillupdate",i.getBlueprint()),n._model=i,t=function(t,e){try{var i=t()}catch(t){return e(t)}return i&&i.then?i.then(void 0,e):i}(function(){var e=n._gatherViews().map(function(t){return t.setModel(i)});return A(i.doc,function(t){return n._throwOnUnknownViews(t),n._options.updateDocument(t),A(Promise.all(e),function(){c(window,"pagedidupdate",i.getBlueprint())})})},function(t){console.error(t),window.location.href=i.url}),e=function(){n._queuedModel!==i&&n._updatePage(n._queuedModel)},t&&t.then?t.then(e):e(t)})},{key:"_addHistoryEntry",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i={title:document.title,url:t.url,model:t.getBlueprint()};history[e?"replaceState":"pushState"](i,document.title,t.url),c(window,"statechange",i)}}],[{key:"options",get:function(){return{defaultHints:[],transitions:{},sanitizeUrl:function(t){return t},updateDocument:function(t){document.title=t.title},attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),i}());t.View=b,t.Model=w,t.Transition=v,t.Attributes=s,t.default=q,Object.defineProperty(t,"__esModule",{value:!0})});
