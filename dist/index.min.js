!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.lipgloss={})}(this,function(t){"use strict";var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),n=new(function(){function t(){e(this,t),this._order=[]}return i(t,[{key:"push",value:function(t){this._order=[t].concat(function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(this._order.filter(function(e){return t.name!==e.name})))}},{key:"delete",value:function(t){this._order=this._order.filter(function(e){return t.name!==e.name})}},{key:"order",get:function(){return this._order}}]),t}()),r=new(function(){function t(){e(this,t),this._attributes={view:"data-view",viewLink:"data-view-link",viewActive:"data-view-active",viewsLoading:"data-views-loading",deactivateView:"data-deactivate-view",transition:"data-transition"}}return i(t,[{key:"assign",value:function(t){this._attributes=Object.assign(this._attributes,t)}},{key:"dict",get:function(){return this._attributes}}]),t}()),o=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}(),s=function(t){return t.offsetHeight},u=function(){function t(i){e(this,t),this._view=i,this.didExit=this.didEnter=this.didComplete=Promise.resolve()}return i(t,[{key:"start",value:function(){var t=this;this.didExit=new Promise(function(e){return t.exitDone=e}),this.didEnter=new Promise(function(e){return t.enterDone=e}),this.didComplete=Promise.all([this.didExit,this.didEnter])}},{key:"exit",value:o(function(){this._view.removeAttribute(r.dict.transition),s(this._view),this._view.setAttribute(r.dict.transition,"out")})},{key:"loading",value:o(function(){this._view.removeAttribute(r.dict.transition),s(this._view),this._view.setAttribute(r.dict.transition,"loading")})},{key:"enter",value:o(function(t,e){this.updateHtml(t),this._view.removeAttribute(r.dict.transition),s(this._view),this._view.setAttribute(r.dict.transition,"in")})},{key:"updateHtml",value:function(t){var e={bubbles:!0,cancelable:!0};this._view.dispatchEvent(new CustomEvent("viewhtmlwillupdate",e)),this._view.innerHTML=t.innerHTML,this._view.dispatchEvent(new CustomEvent("viewhtmldidupdate",e))}},{key:"done",value:function(){this.exitDone(),this.enterDone(),this._view.removeAttribute(r.dict.transition),s(this._view)}},{key:"view",get:function(){return this._view}}]),t}(),a=0,c=function(){function t(i,n){e(this,t),this._request=new Request(i.url,n),this._hints=i.hints||[],this._doc=null,this._id=i.id||a++}return i(t,[{key:"hasHint",value:function(t){return this._hints.includes(t)}},{key:"equals",value:function(t){return!!t&&(this===t||this.id===t.id)}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=fetch(this._request).then(function(t){return t.ok?t:Promise.reject()}).then(function(t){return t.text()}).then(function(t){return(new DOMParser).parseFromString(t,"text/html")})),this._doc}},{key:"blueprint",get:function(){return{id:this._id,url:this._request.url,hints:this._hints}}}]),t}();function l(t,e){if(!e)return Promise.resolve(t).then(d)}function d(){}var h=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}();function f(t,e,i){return i?e?e(t):t:(t=Promise.resolve(t),e?t.then(e):t)}var v=function(){function t(i){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e(this,t),this._element=i,this._options=Object.assign(t.options,o),this.active=!!this._element.innerHTML.trim(),this._model=this._options.model,this._selector="["+r.dict.view+'="'+this._options.name+'"]',this._transition=new this._options.transition(this._element),!(this._transition instanceof u))throw new Error("Provided transition is not an instance of Transition");n.push(this)}return i(t,[{key:"updateModel",value:h(function(t){var e=this;if(!t.equals(e.model)){if(!t.hasHint(e._options.name))return f(t.doc,function(i){var n=i.querySelector(e._selector);if(n){var r=n&&Boolean(n.innerHTML.trim());e.model=r?t:null}});e.model=t}})},{key:"_activate",value:h(function(t){var e=this;e.loading=!0,t.doc.then(function(){return e.loading=!1});var i=e.active;return f(i&&e._exit(),function(){return e.loading&&e._transition.loading(),f(t.doc,function(t){var i,n=t.querySelector(e._selector);return n||(i=e.name,console.warn("Hint '"+i+"' was given, but not found in the loaded document.")),e.active=!0,l(e._enter(n,t))})},!i)})},{key:"_deactivate",value:h(function(){if(this.active)return this.active=!1,l(this._exit())})},{key:"_enter",value:h(function(t,e){var i=this;return i._dispatch("viewwillenter"),f(i._transition.enter(t,e),function(){i._transition.enterDone(),i._dispatch("viewdidenter")})})},{key:"_exit",value:h(function(){var t=this;return t._dispatch("viewwillexit"),f(t._transition.exit(),function(){t._transition.exitDone(),t._dispatch("viewdidexit")})})},{key:"_dispatch",value:function(t){this._element.dispatchEvent(new CustomEvent(t,{bubbles:!0,cancelable:!0}))}},{key:"active",get:function(){return this._active},set:function(t){this._active=t,this._element.setAttribute(r.dict.viewActive,t),t?n.push(this):n.delete(this)}},{key:"loading",get:function(){return this._isLoading},set:function(t){if(this._isLoading!==t){this._isLoading=t;var e=document.body.getAttribute(r.dict.viewsLoading)||"",i=new Set(e.split(" "));t?i.add(this.name):i.delete(this.name),document.body.setAttribute(r.dict.viewsLoading,Array.from(i).join(" "))}}},{key:"model",get:function(){return this._model},set:function(t){var e=this;this._model=t,this._transition.start(),(t?this._activate(t):this._deactivate()).then(function(){return e._transition.done()})}},{key:"name",get:function(){return this._options.name}},{key:"transition",get:function(){return this._transition}}],[{key:"options",get:function(){return{name:null,transition:u,model:null}}}]),t}();function _(){}function w(t,e,i){return i?e?e(t):t:(t=Promise.resolve(t),e?t.then(e):t)}var p=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}(),y="pushState"in history,m=function(t){throw new Error("Not able to determine where ["+r.dict.view+"='"+t+"'] should be inserted.")},g=new(function(){function t(){e(this,t)}return i(t,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(y){if(this._initialized)throw new Error("You can only initialize Lipgloss once.");this._initialized=!0,this._options=Object.assign(t.options,e),this._viewsMap=new WeakMap,r.assign(this._options.attributes),this._model=new c({url:this._options.sanitizeUrl(window.location.href),hints:this._options.defaultHints},this._options.fetch),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document)}}},{key:"getViews",value:function(){var t=this;return Array.from(document.querySelectorAll("["+r.dict.view+"]")).map(function(e){return t._viewsMap.get(e)})}},{key:"didExit",value:function(t){return this._getViewByName(t).transition.didExit}},{key:"didEnter",value:function(t){return this._getViewByName(t).transition.didEnter}},{key:"didComplete",value:function(t){return this._getViewByName(t).transition.didComplete}},{key:"_bindEvents",value:function(){var t=this;this._onLinkClick=this._onLinkClick.bind(this),this._onDeactivateViewClick=this._onDeactivateViewClick.bind(this),document.addEventListener("viewdidenter",function(e){return t.initializeContext(e.target)}),window.addEventListener("popstate",function(e){return t._onPopState(e)})}},{key:"initializeContext",value:function(t){var e=this;Array.from(t.querySelectorAll("["+r.dict.view+"]")).filter(function(t){return!e._viewsMap.has(t)}).forEach(function(t){return e._viewsMap.set(t,e._buildView(t,e._model))}),Array.from(t.querySelectorAll("[href]["+r.dict.viewLink+"]")).forEach(function(t){return t.addEventListener("click",e._onLinkClick)}),Array.from(t.querySelectorAll("["+r.dict.deactivateView+"]")).forEach(function(t){return t.addEventListener("click",e._onDeactivateViewClick)})}},{key:"_buildView",value:function(t,e){var i=t.getAttribute(r.dict.view),n=t.hasAttribute(r.dict.persistView),o=this._options.transitions[i]||u;return new v(t,{name:i,transition:o,persist:n,model:e})}},{key:"_throwOnUnknownViews",value:function(t){var e=this.getViews();Array.from(t.querySelectorAll("["+r.dict.view+"]")).map(function(t){return t.getAttribute(r.dict.view)}).filter(function(t){return!e.some(function(e){return e.name===t})}).forEach(m)}},{key:"_onLinkClick",value:p(function(t){t.preventDefault();var e=this._options.sanitizeUrl(t.currentTarget.href),i=t.currentTarget.getAttribute(r.dict.viewLink),n=i?i.split(","):this._options.defaultHints;this.openUrl(e,n)})},{key:"openUrl",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._options.defaultHints,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._options.fetch;e=Array.isArray(e)?e:[e];var n=new c({url:t,hints:e},i);this._updatePage(n),this._addHistoryEntry(n)}},{key:"_onDeactivateViewClick",value:function(t){t.preventDefault();var e=t.currentTarget.getAttribute(r.dict.deactivateView);this.deactivateView(e)}},{key:"deactivateView",value:function(t){var e=this,i=n.order.find(function(t){return!e._model.equals(t.model)});if(!i)throw new Error("Unable to deactivate view "+t+", because there's no view to fall back to.");n.delete(this._getViewByName(t)),this._updatePage(i.model),this._addHistoryEntry(i.model)}},{key:"_getViewByName",value:function(t){var e=document.querySelector("["+r.dict.view+'="'+t+'"]');return this._viewsMap.get(e)}},{key:"_onPopState",value:function(t){try{var e=new c(t.state.model,this._options.fetch);this._updatePage(e)}catch(t){}}},{key:"_updatePage",value:p(function(t){var e=this;return function(t){if(t&&t.then)return t.then(_)}(function(t,e){try{var i=t()}catch(t){try{return e(t)}catch(t){return Promise.reject(t)}}return i&&i.then?i.then(void 0,e):i}(function(){window.dispatchEvent(new CustomEvent("pagewillupdate",{detail:t.blueprint})),e._model=t;var i=e.getViews();i.forEach(function(e){return e.updateModel(t)});var n=Promise.all(i.map(function(t){return t.transition.didComplete}));return w(t.doc,function(t){return e._throwOnUnknownViews(t),e._options.updateDocument(t),w(n,function(){window.dispatchEvent(new CustomEvent("pagedidupdate"))})})},function(e){console.error(e),window.location.href=t.url}))})},{key:"_addHistoryEntry",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i={title:document.title,url:t.url,model:t.blueprint};history[e?"replaceState":"pushState"](i,document.title,t.url),window.dispatchEvent(new CustomEvent("statechange",{detail:i}))}}],[{key:"options",get:function(){return{defaultHints:[],transitions:{},sanitizeUrl:function(t){return t},updateDocument:function(t){document.title=t.title},attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),t}());t.View=v,t.Model=c,t.Transition=u,t.Attributes=r,t.default=g,Object.defineProperty(t,"__esModule",{value:!0})});
