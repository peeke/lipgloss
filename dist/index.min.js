!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).lipgloss={})}(this,function(e){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function o(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}function i(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var u=new(function(){function e(){n(this,e),this._order=[]}return o(e,[{key:"push",value:function(t){this._order=[t].concat(i(this._order.filter(function(e){return t.name!==e.name})))}},{key:"delete",value:function(t){this._order=this._order.filter(function(e){return t.name!==e.name})}},{key:"has",value:function(e){return this._order.includes(e)}},{key:"order",get:function(){return this._order}}]),e}()),a={view:"data-view",slot:"data-view-slot",viewLink:"data-view-link",viewActive:"data-view-active",viewsLoading:"data-views-loading",viewsActive:"data-views-active",deactivateView:"data-deactivate-view",transition:"data-transition"},s=function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};Array.from(e).forEach(function(e){return e.addEventListener(t,i,n)})},c=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};e.dispatchEvent(new CustomEvent(t,{detail:i,bubbles:!0,cancelable:!0}))},l=function(e){return e.offsetHeight},d={list:function(e,t){var i=e.getAttribute(t)||"";return new Set(i.split(" ").filter(Boolean))},add:function(e,t,i){d.toggle(e,t,i,!0)},remove:function(e,t,i){d.toggle(e,t,i,!1)},has:function(e,t,i){return d.list(e,t).has(i)},toggle:function(e,t,i,n){var r=d.list(e,t);void 0===n&&(n=!r.has(i)),r[n?"add":"delete"](i),e.setAttribute(t,Array.from(r).join(" "))}};function v(i){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return Promise.resolve(i.apply(this,e))}catch(e){return Promise.reject(e)}}}function h(e,t,i){return i?t?t(e):e:(e&&e.then||(e=Promise.resolve(e)),t?e.then(t):e)}var f=function(){function t(e){n(this,t),this._view=e}return o(t,[{key:"beforeExit",value:function(){return h()}},{key:"exit",value:v(function(){this._view.removeAttribute(a.transition),l(this._view),this._view.setAttribute(a.transition,"out")})},{key:"beforeEnter",value:function(){return h()}},{key:"enter",value:v(function(e,t){this.updateHtml(e),this._view.removeAttribute(a.transition),l(this._view),this._view.setAttribute(a.transition,"in")})},{key:"updateHtml",value:function(e){c(this._view,"viewhtmlwillupdate"),this._view.innerHTML=e.innerHTML,c(this._view,"viewhtmldidupdate")}},{key:"done",value:function(){this._view.removeAttribute(a.transition),l(this._view)}},{key:"view",get:function(){return this._view}}]),t}();var _=0,w={},m=function(){function e(t){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};n(this,e),this._request=new Request(t.url,i),this._doc=null,this._id="number"==typeof t.id?t.id:[Date.now(),_++].join("-"),(w[this._id]=this)._response=fetch(this._request).then(function(e){return e.ok?e:Promise.reject()}).then(function(e){return"error"!==i.redirect?e:t.url!==e.url?Promise.reject():e})}var i;return o(e,[{key:"includesView",value:(i=function(t){var e,i,n;return e=this.doc,i=function(e){return Boolean(e.querySelector("[".concat(a.view,'="').concat(t,'"]')))},n?i?i(e):e:(e&&e.then||(e=Promise.resolve(e)),i?e.then(i):e)},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return Promise.resolve(i.apply(this,e))}catch(e){return Promise.reject(e)}})},{key:"equals",value:function(e){return!!e&&this.id===e.id}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=this._response.then(function(e){return e.text()}).then(function(e){return(new DOMParser).parseFromString(e,"text/html")})),this._doc}}],[{key:"getById",value:function(e){return w[e]}}]),e}();function y(e,t){if(!t)return e&&e.then?e.then(p):Promise.resolve()}function p(){}function t(i){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return Promise.resolve(i.apply(this,e))}catch(e){return Promise.reject(e)}}}function g(e,t,i){return i?t?t(e):e:(e&&e.then||(e=Promise.resolve(e)),t?e.then(t):e)}var k=function(){function i(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(n(this,i),this._element=e,this._options=Object.assign(i.options,t),this.active=this.visible=!!this._element.innerHTML.trim(),this._model=this._options.model,this._selector="[".concat(a.view,'="').concat(this._options.name,'"]'),this._transition=new this._options.transition(this._element),this.active&&u.push(this),!(this._transition instanceof f))throw new Error("Provided transition is not an instance of Transition")}return o(i,[{key:"setModel",value:t(function(i){var n=this;if(!i||!i.equals(n._model))return g(i.includesView(n._options.name),function(e){if(e)return c(n._element,"viewwillupdate"),g(i.doc,function(e){var t=e.querySelector(n._selector);return g(t&&Boolean(t.innerHTML.trim())?n._activate(i):n._deactivate(),function(e){n._transition.done(),c(n._element,"viewdidupdate")})})})})},{key:"_activate",value:t(function(e){var t,i,n=this;return n._model=e,n.loading=!0,e.doc.then(function(){return n.loading=!1}),t=function(){return g(e.doc,function(e){var t,i=e.querySelector(n._selector);if(!i)throw t=n.name,new Error("View '".concat(t,"' activated, but not found in the loaded document"));return Boolean(i.innerHTML.trim())?(u.has(n)||u.push(n),g(n._transition.beforeEnter(i,e),function(){return n.visible=!0,n.active=!0,y(n._enter(i,e))})):(n.active=!1,void(n.visible=!1))})},(i=function(){if(n.active)return g(n._transition.beforeExit(),function(){return y(n._exit(e.doc))})}())&&i.then?i.then(t):t(i)})},{key:"_deactivate",value:t(function(){var e=this;if(e.active)return u.delete(e),g(e._transition.beforeExit(),function(){return e.active=!1,g(e._exit(),function(){e.visible=!1,e._model=null})})})},{key:"_enter",value:t(function(e,t){var i=this;return c(i._element,"viewwillenter"),g(i._transition.enter(e,t),function(){c(i._element,"viewdidenter")})})},{key:"_exit",value:t(function(e){var t=this;return c(t._element,"viewwillexit"),g(t._transition.exit(e),function(){c(t._element,"viewdidexit")})})},{key:"active",get:function(){return this._active},set:function(e){this._active!==e&&(this._active=e,this._element.setAttribute(a.viewActive,e),d.toggle(document.body,"data-views-active",this.name,e))}},{key:"visible",set:function(e){this._visible!==e&&(this._visible=e,this._element.setAttribute(a.viewActive,e),d.toggle(document.body,"data-views-visible",this.name,e))}},{key:"loading",get:function(){return this._isLoading},set:function(e){this._isLoading!==e&&(this._isLoading=e,d.toggle(document.body,a.viewsLoading,this.name,e))}},{key:"name",get:function(){return this._options.name}},{key:"transition",get:function(){return this._transition}},{key:"model",get:function(){return this._model}}],[{key:"options",get:function(){return{name:null,transition:f,model:null}}}]),i}();function b(){}function A(i){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{return Promise.resolve(i.apply(this,e))}catch(e){return Promise.reject(e)}}}var P="pushState"in history,q=new(function(){function i(){n(this,i)}return o(i,[{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(P){this._options=Object.assign({},i.options,e),this._viewsMap=new WeakMap,this._views=[],Object.assign(a,this._options.attributes);var t=this._options.sanitizeUrl(window.location.href);this._model=new m({url:t},this._options.fetch),this._queuedModel=this._model,this._updatingPage=!1,this._onLinkClick=this._onLinkClick.bind(this),this._onDeactivateViewClick=this._onDeactivateViewClick.bind(this),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document),c(window,"lipglossready")}}},{key:"isActive",value:function(e){var t=this._getViewByName(e);return t&&t.active}},{key:"_bindEvents",value:function(){var t=this;document.addEventListener("viewdidenter",function(e){return t.initializeContext(e.target)}),window.addEventListener("popstate",function(e){return t._onPopState(e)})}},{key:"initializeContext",value:function(e){var i=this,t="[".concat(a.view,"], [").concat(a.slot,"]");Array.from(e.querySelectorAll(t)).filter(function(e){return!i._viewsMap.has(e)}).forEach(function(e){var t=i._createView(e,i._model);i._viewsMap.set(e,t),i._views.push(t)}),s(e.querySelectorAll("[href][".concat(a.viewLink,"]")),"click",this._onLinkClick),s(e.querySelectorAll("[".concat(a.deactivateView,"]")),"click",this._onDeactivateViewClick)}},{key:"_createView",value:function(e,t){var i=e.getAttribute(a.view)||e.getAttribute(a.slot),n=this._options.transitions[i]||f;return new k(e,{name:i,transition:n,model:t})}},{key:"_onLinkClick",value:A(function(e){e.preventDefault();var t=this._options.sanitizeUrl(e.currentTarget.href);this.openUrl(t)})},{key:"openUrl",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this._options.fetch,i=new m({url:e},t),n=this._model&&this._model.equals(i);this._queueModel(i),this._addHistoryEntry(i,n)}},{key:"_onDeactivateViewClick",value:function(e){e.preventDefault();var t=e.currentTarget.getAttribute(a.deactivateView);this.deactivateView(t)}},{key:"deactivateView",value:function(e){var t=this._getViewByName(e),i=u.order.find(function(e){return!e.model.equals(t.model)});if(!i)throw new Error("Unable to deactivate view ".concat(e,", because there's no view to fall back to."));this._queueModel(i.model),this._addHistoryEntry(i.model)}},{key:"_getViewByName",value:function(t){return this._views.find(function(e){return e.name===t})}},{key:"_onPopState",value:function(e){if(e.state)try{var t=m.getById(e.state.modelId);if(!t){var i={url:e.state.url,id:e.state.modelId};t=new m(i,this._options.fetch)}this._queueModel(t)}catch(e){console.error(e),window.location.href=model.url}}},{key:"_queueModel",value:function(e){this._queuedModel=e,this._updatingPage||this._setModel(e)}},{key:"_setModel",value:A(function(n){var e,t,r=this;return r._model=n,r._updatingPage=!0,e=function(e,t){try{var i=e()}catch(e){return t(e)}return i&&i.then?i.then(void 0,t):i}(function(){return c(window,"pagewillupdate"),r._views.forEach(A(function(e){return function(e,t){if(!t)return e&&e.then?e.then(b):Promise.resolve()}(e.setModel(n))})),e=n.doc,t=function(e){r._options.updateDocument(e),r._views=r._views.filter(function(e){return Boolean(document.querySelector((t=e.name,"\n  [".concat(a.view,"=").concat(t,"],\n  [").concat(a.slot,"=").concat(t,"]\n"))));var t}),c(window,"pagedidupdate")},i?t?t(e):e:(e&&e.then||(e=Promise.resolve(e)),t?e.then(t):e);var e,t,i},function(e){console.error(e),window.location.href=n.url}),t=function(){r._updatingPage=!1,r._queuedModel!==n&&r._setModel(r._queuedModel)},e&&e.then?e.then(t):t(e)})},{key:"_addHistoryEntry",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i={title:document.title,url:e.url,model:e.id};history[t?"replaceState":"pushState"](i,document.title,e.url),c(window,"statechange",i)}}],[{key:"options",get:function(){return{transitions:{},sanitizeUrl:function(e){return e},updateDocument:function(e){document.title=e.title},attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),i}());e.View=k,e.Model=m,e.Transition=f,e.Attributes=a,e.default=q,Object.defineProperty(e,"__esModule",{value:!0})});
