!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.lipgloss={})}(this,function(t){"use strict";var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),n=new(function(){function t(){e(this,t),this._order=[]}return i(t,[{key:"push",value:function(t){this._order=[t].concat(function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(this._order.filter(function(e){return t.name!==e.name})))}},{key:"delete",value:function(t){this._order=this._order.filter(function(e){return t.name!==e.name})}},{key:"has",value:function(t){return this._order.includes(t)}},{key:"order",get:function(){return this._order}}]),t}()),r=new(function(){function t(){e(this,t),this._attributes={view:"data-view",slot:"data-view-slot",viewLink:"data-view-link",viewActive:"data-view-active",viewsLoading:"data-views-loading",viewsActive:"data-views-active",deactivateView:"data-deactivate-view",transition:"data-transition"}}return i(t,[{key:"assign",value:function(t){this._attributes=Object.assign(this._attributes,t)}},{key:"dict",get:function(){return this._attributes}}]),t}()),o=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};Array.from(t).forEach(function(t){return t.addEventListener(e,i,n)})},u=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};t.dispatchEvent(new CustomEvent(e,{detail:i,bubbles:!0,cancelable:!0}))},s=function(t){return t.offsetHeight},a=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}();function c(t,e,i){return i?e?e(t):t:(t=Promise.resolve(t),e?t.then(e):t)}var l=function(){function t(i){e(this,t),this._view=i,this.willExit=this.willEnter=this.didExit=this.didEnter=this.didComplete=Promise.resolve(),this.exitStart=this.enterStart=this.exitDone=this.enterDone=function(){}}return i(t,[{key:"reset",value:function(){var t=this;this.willExit=new Promise(function(e){return t.exitStart=e}),this.willEnter=new Promise(function(e){return t.enterStart=e}),this.didExit=new Promise(function(e){return t.exitDone=e}),this.didEnter=new Promise(function(e){return t.enterDone=e}),this.didComplete=Promise.all([this.didExit,this.didEnter])}},{key:"beforeExit",value:function(){return c()}},{key:"exit",value:a(function(){this._view.removeAttribute(r.dict.transition),s(this._view),this._view.setAttribute(r.dict.transition,"out")})},{key:"loading",value:a(function(){this._view.removeAttribute(r.dict.transition),s(this._view),this._view.setAttribute(r.dict.transition,"loading")})},{key:"beforeEnter",value:function(){return c()}},{key:"enter",value:a(function(t,e){this.updateHtml(t),this._view.removeAttribute(r.dict.transition),s(this._view),this._view.setAttribute(r.dict.transition,"in")})},{key:"updateHtml",value:function(t){u(this._view,"viewhtmlwillupdate"),this._view.innerHTML=t.innerHTML,u(this._view,"viewhtmldidupdate")}},{key:"done",value:function(){this.exitStart(),this.exitDone(),this.enterStart(),this.enterDone(),this._view.removeAttribute(r.dict.transition),s(this._view)}},{key:"view",get:function(){return this._view}}]),t}(),h=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}();var d=0,f={},v=function(){return[Date.now(),d++].join("-")},_=function(t){return Number(t)===t},w=function(){function t(i){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this._request=new Request(i.url,r),this._hints=i.hints||[],this._doc=null,this._id=_(i.id)?i.id:v(),f[this._id]=this,u(window,"modelload"),this._response=fetch(this._request).then(function(t){return t.ok?t:Promise.reject()}).then(function(t){return"error"!==r.redirect?t:i.url!==t.url?Promise.reject():t}),this._response.then(function(){return u(window,"modelloaded",n.getBlueprint())})}return i(t,[{key:"hasHint",value:function(t){return this._hints.includes(t)}},{key:"includesView",value:h(function(t){var e,i,n;return e=this.doc,i=function(e){return Boolean(e.querySelector("["+r.dict.view+'="'+t+'"]'))},n?i?i(e):e:(e=Promise.resolve(e),i?e.then(i):e)})},{key:"equals",value:function(t){return!!t&&(this===t||this.id===t.id)}},{key:"getBlueprint",value:function(){return{id:this._id,url:this._request.url,hints:this._hints}}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=this._response.then(function(t){return t.text()}).then(function(t){return(new DOMParser).parseFromString(t,"text/html")})),this._doc}}],[{key:"getById",value:function(t){return f[t]}}]),t}(),y=function(){function t(i,n){e(this,t),this._element=i,this._attribute=n}return i(t,[{key:"_getList",value:function(){var t=this._element.getAttribute(this._attribute)||"";return new Set(t.split(" ").filter(Boolean))}},{key:"add",value:function(t){this.toggle(t,!0)}},{key:"remove",value:function(t){this.toggle(t,!1)}},{key:"has",value:function(t){return this._getList().has(t)}},{key:"toggle",value:function(t,e){var i=this._getList();void 0===e&&(e=!i.has(t)),i[e?"add":"delete"](t),this._element.setAttribute(this._attribute,Array.from(i).join(" "))}}]),t}();function m(t,e){if(!e)return Promise.resolve(t).then(p)}function p(){}var g=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}();function k(t,e){var i=t();return i&&i.then?i.then(e):e(i)}function b(t,e,i){return i?e?e(t):t:(t=Promise.resolve(t),e?t.then(e):t)}var P=function(){function t(i){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e(this,t),this._element=i,this._options=Object.assign(t.options,o),this._loadingList=new y(document.body,r.dict.viewsLoading),this._activeList=new y(document.body,r.dict.viewsActive),this._visibleList=new y(document.body,"data-views-visible"),this.active=this.visible=!!this._element.innerHTML.trim(),this._model=this._options.model,this._selector="["+r.dict.view+'="'+this._options.name+'"]',this._transition=new this._options.transition(this._element),this.active&&n.push(this),!(this._transition instanceof l))throw new Error("Provided transition is not an instance of Transition")}return i(t,[{key:"_setModel",value:g(function(t){var e=this;if(!t||!t.equals(e._model)){var i=t.hasHint(e._options.name);return b(i||t.includesView(e._options.name),function(n){var r;if(n)return k(function(){if(i)return b(e._activate(t),function(){e._transition.done(),r=1})},function(i){return r?i:b(t.doc,function(i){var n=i.querySelector(e._selector);return b(n&&Boolean(n.innerHTML.trim())?e._activate(t):e._deactivate(),function(){e._transition.done()})})});e._transition.done()},i)}e._transition.done()})},{key:"_activate",value:g(function(t){var e=this;return e.loading=!0,t.doc.then(function(){return e.loading=!1}),k(function(){if(e.active)return b(e._transition.beforeExit(),function(){return m(e._exit())});e._transition.exitStart(),e._transition.exitDone()},function(){return k(function(){if(e.loading)return m(e._transition.loading())},function(){return b(t.doc,function(i){var r,o=i.querySelector(e._selector);if(!o)throw r=e.name,new Error("View '"+r+"' activated, but not found in the loaded document (maybe you've provided it as a hint?).");return Boolean(o.innerHTML.trim())?(n.has(e)||n.push(e),b(e._transition.beforeEnter(o,i),function(){return e.visible=!0,e.active=!0,b(e._enter(o,i),function(){e._model=t})})):(e.active=!1,void(e.visible=!1))})})})})},{key:"_deactivate",value:g(function(){var t=this;if(t.active)return n.delete(t),b(t._transition.beforeExit(),function(){return t.active=!1,b(t._exit(),function(){t.visible=!1,t._model=null})})})},{key:"_enter",value:g(function(t,e){var i=this;return i._transition.enterStart(),u(i._element,"viewwillenter"),b(i._transition.enter(t,e),function(){u(i._element,"viewdidenter"),i._transition.enterDone()})})},{key:"_exit",value:g(function(){var t=this;return t._transition.exitStart(),u(t._element,"viewwillexit"),b(t._transition.exit(),function(){u(t._element,"viewdidexit"),t._transition.exitDone()})})},{key:"active",get:function(){return this._active},set:function(t){this._active!==t&&(this._active=t,this._element.setAttribute(r.dict.viewActive,t),this._activeList.toggle(this._options.name,t))}},{key:"visible",set:function(t){this._visible!==t&&(this._visible=t,this._element.setAttribute(r.dict.viewActive,t),this._visibleList.toggle(this._options.name,t))}},{key:"loading",get:function(){return this._isLoading},set:function(t){this._isLoading!==t&&(this._isLoading=t,this._loadingList.toggle(this._options.name,t))}},{key:"model",get:function(){return this._model},set:function(t){this._setModel(t)}},{key:"name",get:function(){return this._options.name}},{key:"transition",get:function(){return this._transition}}],[{key:"options",get:function(){return{name:null,transition:l,model:null}}}]),t}();function A(t,e,i){return i?e?e(t):t:(t=Promise.resolve(t),e?t.then(e):t)}var E=function(){try{if(isNaN.apply(null,{}))return function(t){return function(){try{return Promise.resolve(t.apply(this,arguments))}catch(t){return Promise.reject(t)}}}}catch(t){}return function(t){return function(){try{return Promise.resolve(t.apply(this,Array.prototype.slice.call(arguments)))}catch(t){return Promise.reject(t)}}}}(),x="pushState"in history,L=new(function(){function t(){e(this,t)}return i(t,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(x){this._options=Object.assign({},t.options,e),this._viewsMap=new WeakMap,r.assign(this._options.attributes);var i=this._options.sanitizeUrl(window.location.href);this._model=new w({url:i,hints:this._options.defaultHints},this._options.fetch),this._queuedModel=this._model,this._updatingPage=!1,this._onLinkClick=this._onLinkClick.bind(this),this._onDeactivateViewClick=this._onDeactivateViewClick.bind(this),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document),u(window,"lipglossready")}}},{key:"_gatherViews",value:function(){var t=this,e="["+r.dict.view+"], ["+r.dict.slot+"]";return Array.from(document.querySelectorAll(e)).map(function(e){return t._viewsMap.get(e)})}},{key:"isActive",value:function(t){var e=this._getViewByName(t);return e&&e.active}},{key:"_bindEvents",value:function(){var t=this;document.addEventListener("viewdidenter",function(e){return t.initializeContext(e.target)}),window.addEventListener("popstate",function(e){return t._onPopState(e)})}},{key:"initializeContext",value:function(t){var e=this,i="["+r.dict.view+"], ["+r.dict.slot+"]";Array.from(t.querySelectorAll(i)).filter(function(t){return!e._viewsMap.has(t)}).forEach(function(t){return e._viewsMap.set(t,e._createView(t,e._model))}),o(t.querySelectorAll("[href]["+r.dict.viewLink+"]"),"click",this._onLinkClick),o(t.querySelectorAll("["+r.dict.deactivateView+"]"),"click",this._onDeactivateViewClick)}},{key:"_createView",value:function(t,e){var i=t.getAttribute(r.dict.view)||t.getAttribute(r.dict.slot),n=this._options.transitions[i]||l;return new P(t,{name:i,transition:n,model:e})}},{key:"_throwOnUnknownViews",value:function(t){var e=this._gatherViews();Array.from(t.querySelectorAll("["+r.dict.view+"]")).map(function(t){return t.getAttribute(r.dict.view)}).filter(function(t){return!e.some(function(e){return e.name===t})}).forEach(function(t){throw new Error((e=t,"Not able to determine where ["+r.dict.view+"='"+e+"'] should be inserted."));var e})}},{key:"_onLinkClick",value:E(function(t){t.preventDefault();var e=this._options.sanitizeUrl(t.currentTarget.href),i=t.currentTarget.getAttribute(r.dict.viewLink),n=i?i.split(","):this._options.defaultHints;this.openUrl(e,n)})},{key:"openUrl",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._options.defaultHints,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._options.fetch;e=Array.isArray(e)?e:[e];var n=new w({url:t,hints:e},i),r=this._model&&this._model.equals(n);this._queuePageUpdate(n),this._addHistoryEntry(n,r)}},{key:"_onDeactivateViewClick",value:function(t){t.preventDefault();var e=t.currentTarget.getAttribute(r.dict.deactivateView);this.deactivateView(e)}},{key:"deactivateView",value:function(t){var e=this._getViewByName(t),i=n.order.find(function(t){return!t.model.equals(e.model)});if(!i)throw new Error("Unable to deactivate view "+t+", because there's no view to fall back to.");this._queuePageUpdate(i.model),this._addHistoryEntry(i.model)}},{key:"_getViewByName",value:function(t){var e=document.querySelector("["+r.dict.view+'="'+t+'"], ['+r.dict.slot+'="'+t+'"]');return this._viewsMap.get(e)}},{key:"_onPopState",value:function(t){if(t.state)try{var e=w.getById(t.state.model.id)||new w(t.state.model,this._options.fetch);this._queuePageUpdate(e)}catch(t){console.error(t),window.location.href=model.url}}},{key:"_queuePageUpdate",value:function(t){this._queuedModel=t,this._updatingPage||this._updatePage(t)}},{key:"_updatePage",value:E(function(t){var e,i,n=this;return n._updatingPage=!0,u(window,"pagewillupdate",t.getBlueprint()),n._model=t,e=function(t,e){try{var i=t()}catch(t){try{return e(t)}catch(t){return Promise.reject(t)}}return i&&i.then?i.then(void 0,e):i}(function(){var e=n._gatherViews();e.forEach(function(t){return t.transition.reset()}),e.forEach(function(e){e.model=t});var i=Promise.all(e.map(function(t){return t.transition.didComplete}));return A(t.doc,function(e){return n._throwOnUnknownViews(e),n._options.updateDocument(e),A(i,function(){u(window,"pagedidupdate",t.getBlueprint())})})},function(e){console.error(e),window.location.href=t.url}),i=function(){n._queuedModel!==t&&n._updatePage(n._queuedModel),n._updatingPage=!1},e&&e.then?e.then(i):i(e)})},{key:"_addHistoryEntry",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i={title:document.title,url:t.url,model:t.getBlueprint()};history[e?"replaceState":"pushState"](i,document.title,t.url),u(window,"statechange",i)}}],[{key:"options",get:function(){return{defaultHints:[],transitions:{},sanitizeUrl:function(t){return t},updateDocument:function(t){document.title=t.title},attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),t}());t.View=P,t.Model=w,t.Transition=l,t.Attributes=r,t.default=L,Object.defineProperty(t,"__esModule",{value:!0})});
