!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.lipgloss={})}(this,function(t){"use strict";var e=function(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){return function i(r,s){try{var a=e[r](s),o=a.value}catch(t){return void n(t)}if(!a.done)return Promise.resolve(o).then(function(t){i("next",t)},function(t){i("throw",t)});t(o)}("next")})}},n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=new(function(){function t(){n(this,t),this._overrides={}}return i(t,[{key:"assign",value:function(t){this._overrides=Object.assign(this._overrides,t)}},{key:"attribute",value:function(t){return this._overrides[t]||t}}]),t}()),s=function(t){return r.attribute(t)},a=function(t){return t.offsetHeight},o=function(){function t(e){n(this,t),this._view=e}return i(t,[{key:"exit",value:(u=e(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this._view.removeAttribute(s("data-transition")),a(this._view),this._view.setAttribute(s("data-transition"),"out");case 3:case"end":return t.stop()}},t,this)})),function(){return u.apply(this,arguments)})},{key:"loading",value:(o=e(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this._view.removeAttribute(s("data-transition")),a(this._view),this._view.setAttribute(s("data-transition"),"loading");case 3:case"end":return t.stop()}},t,this)})),function(){return o.apply(this,arguments)})},{key:"enter",value:(r=e(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this._view.innerHTML=e.innerHTML,this._view.removeAttribute(s("data-transition")),a(this._view),this._view.setAttribute(s("data-transition"),"in");case 4:case"end":return t.stop()}},t,this)})),function(t){return r.apply(this,arguments)})}]),t;var r,o,u}(),u=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{bubbles:!0,cancelable:!0};t.dispatchEvent(new CustomEvent(e,n))},c=function(t){return r.attribute(t)},h=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this._element=e,this._options=Object.assign(t.options,i),this.active=!!this._element.innerHTML,this._persist=this._element.hasAttribute(c("data-persist-view")),this._activeModel=this._options.model;var r=this._options.transition;if(this._transition=new r(this._element),!(this._transition instanceof o))throw Error("Provided transition is not an instance of Transition")}return i(t,[{key:"setModel",value:(l=e(regeneratorRuntime.mark(function t(e){var n,i,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.includesView(this._options.name),i=Promise.resolve(n||e.querySelector(this.selector)),t.next=4,i.then(function(){return!0},function(){return!1});case 4:return r=t.sent,t.next=7,r;case 7:if(!t.sent){t.next=11;break}this._activate(e),t.next=12;break;case 11:this._deactivate();case 12:this.active=r;case 13:case"end":return t.stop()}},t,this)})),function(t){return l.apply(this,arguments)})},{key:"_activate",value:(h=e(regeneratorRuntime.mark(function t(e){var n=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!this._activeModel||this._activeModel.url!==e.url){t.next=2;break}return t.abrupt("return");case 2:if(this.loading=!0,e.doc.then(function(){n.loading=!1}),t.t0=this.active,!t.t0){t.next=8;break}return t.next=8,this._exit();case 8:return this.loading&&this._transition.loading(),t.t1=this,t.next=12,e.querySelector(this.selector);case 12:return t.t2=t.sent,t.next=15,t.t1._enter.call(t.t1,t.t2);case 15:this._activeModel=e;case 16:case"end":return t.stop()}},t,this)})),function(t){return h.apply(this,arguments)})},{key:"_deactivate",value:(a=e(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.active){t.next=2;break}return t.abrupt("return");case 2:if(!this._persist){t.next=4;break}return t.abrupt("return");case 4:return t.next=6,this._exit();case 6:this._activeModel=null;case 7:case"end":return t.stop()}},t,this)})),function(){return a.apply(this,arguments)})},{key:"_enter",value:(s=e(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return u(this._element,"viewwillenter",this.eventOptions),t.next=3,this._transition.enter(e);case 3:u(this._element,"viewdidenter",this.eventOptions);case 4:case"end":return t.stop()}},t,this)})),function(t){return s.apply(this,arguments)})},{key:"_exit",value:(r=e(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return u(this._element,"viewwillexit",this.eventOptions),t.next=3,this._transition.exit();case 3:u(this._element,"viewdidexit",this.eventOptions);case 4:case"end":return t.stop()}},t,this)})),function(){return r.apply(this,arguments)})},{key:"eventOptions",get:function(){return{bubbles:!0,cancelable:!0,detail:{name:this._name}}}},{key:"selector",get:function(){return this._options.selector||"["+c("data-view")+'="'+this._options.name+'"]'}},{key:"active",get:function(){return this._active},set:function(t){this._active=t,this._element.setAttribute(c("data-view-active"),t)}},{key:"loading",get:function(){return this._isLoading},set:function(t){var e=this;this._isLoading=t;var n,i=document.body.hasAttribute(c("data-views-loading"))?document.body.getAttribute(c("data-views-loading")).split(" "):[],r=t?(n=[].concat(function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}(i),[this._options.name]),Array.from(new Set(n))):i.filter(function(t){return t!==e._options.name});document.body.setAttribute(c("data-views-loading"),r.join(" "))}},{key:"model",get:function(){return this._activeModel},set:function(t){this._setModel(t)}},{key:"name",get:function(){return this._options.name}}],[{key:"options",get:function(){return{name:null,persist:!1,transition:o,selector:null,model:null}}}]),t;var r,s,a,h,l}(),l=function(){function t(e,i){n(this,t),this._request=new Request(e.url,i),this._hints=e.hints||[],this._doc=null}return i(t,[{key:"includesView",value:function(t){return this._hints.includes(t)}},{key:"querySelector",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"body";return this.doc.then(function(e){return e.querySelector(t)}).then(function(t){return t&&t.innerHTML?t:Promise.reject()})}},{key:"getRepresentation",value:function(){return{url:this._request.url,hints:this._hints}}},{key:"url",get:function(){return this._request.url}},{key:"doc",get:function(){return this._doc||(this._doc=fetch(this._request).then(function(t){return t.ok?t:Promise.reject()}).then(function(t){return t.text()}).then(function(t){return(new DOMParser).parseFromString(t,"text/html")})),this._doc}}]),t}(),f="pushState"in history,d=function(t){return r.attribute(t)},v=new(function(){function t(){n(this,t)}return i(t,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(f){if(this._initialized)throw Error("You can only initialize Lipgloss once.");this._initialized=!0,this._options=Object.assign(t.options,e),this._viewsMap=new WeakMap,r.assign(this._options.attributes);var n=this._options.sanitizeUrl(window.location.href);this._model=new l({url:n,hints:[]},this._options.fetch),this._addHistoryEntry(this._model,!0),this._bindEvents(),this.initializeContext(document)}}},{key:"_bindEvents",value:function(){var t=this;this._onLinkClick=this._onLinkClick.bind(this),this._onActivateViewClick=this._onActivateViewClick.bind(this),document.addEventListener("viewdidenter",function(e){return t.initializeContext(e.target)}),window.addEventListener("popstate",function(e){return t._onPopState(e)})}},{key:"initializeContext",value:function(t){var e=this;Array.from(t.querySelectorAll("["+d("data-view")+"]")).filter(function(t){return!e._viewsMap.has(t)}).forEach(function(t){return e._viewsMap.set(t,e._buildView(t,e._model))}),t.querySelectorAll("[href]["+d("data-view-link")+"]").forEach(function(t){return t.addEventListener("click",e._onLinkClick)}),t.querySelectorAll("["+d("data-activate-view")+"]").forEach(function(t){return t.addEventListener("click",e._onActivateViewClick)})}},{key:"_buildView",value:function(t,e){var n=t.getAttribute(d("data-view")),i=t.hasAttribute(d("data-persist-view")),r=this._options.transitions[n]||o;return new h(t,{name:n,transition:r,persist:i,model:e})}},{key:"_throwOnUnknownViews",value:function(t){var e=this;Array.from(t.querySelectorAll("["+d("data-view")+"]")).map(function(t){return t.getAttribute(d("data-view"))}).filter(function(t){return!e.views.some(function(e){return e.name===t})}).forEach(function(t){throw Error((e=t,"Not able to determine where ["+d("data-view")+"='"+e+"'] should be inserted."));var e})}},{key:"_isCurrentUrl",value:function(t){return this._options.sanitizeUrl(t)===this._options.sanitizeUrl(window.location.href)}},{key:"_onLinkClick",value:(c=e(regeneratorRuntime.mark(function t(e){var n,i,r,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.preventDefault(),n=this._options.sanitizeUrl(e.currentTarget.href),i=e.currentTarget.getAttribute(d("data-view-link")),r=i?i.split(","):this._options.defaultHints,s=new l({url:n,hints:r},this._options.fetch),!this._isCurrentUrl(s.url)){t.next=7;break}return t.abrupt("return");case 7:return t.next=9,this._updatePage(s);case 9:this._addHistoryEntry(s);case 10:case"end":return t.stop()}},t,this)})),function(t){return c.apply(this,arguments)})},{key:"_onActivateViewClick",value:(a=e(regeneratorRuntime.mark(function t(e){var n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e.preventDefault(),n=e.currentTarget.getAttribute(d("data-activate-view")),i=this._getModelFromView(n),!this._isCurrentUrl(i.url)){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,this._updatePage(i);case 7:this._addHistoryEntry(i);case 8:case"end":return t.stop()}},t,this)})),function(t){return a.apply(this,arguments)})},{key:"_getModelFromView",value:function(t){var e=document.querySelector("["+d("data-view")+'="'+t+'"]');return this._viewsMap.get(e).model}},{key:"_onPopState",value:function(t){try{var e=new l(t.state.model,this._options.fetch);this._updatePage(e)}catch(t){}}},{key:"_updatePage",value:(s=e(regeneratorRuntime.mark(function t(e){var n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this._model=e,t.prev=1,n=this.views.map(function(t){return t.setModel(e)}),t.next=5,Promise.all(n);case 5:return t.next=7,e.doc;case 7:i=t.sent,this._throwOnUnknownViews(i),document.title=i.title,t.next=15;break;case 12:t.prev=12,t.t0=t.catch(1),window.location.href=e.url;case 15:case"end":return t.stop()}},t,this,[[1,12]])})),function(t){return s.apply(this,arguments)})},{key:"_addHistoryEntry",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={title:document.title,url:t.url,model:t.getRepresentation()};history[e?"replaceState":"pushState"](n,document.title,t.url),u(window,"statechange",{detail:n})}},{key:"views",get:function(){var t=this;return Array.from(document.querySelectorAll("["+d("data-view")+"]")).map(function(e){return t._viewsMap.get(e)})}}],[{key:"options",get:function(){return{defaultHints:[],transitions:{},sanitizeUrl:function(t){return t},attributes:{},fetch:{credentials:"same-origin",cache:"default",redirect:"error",headers:{"X-Requested-With":"XmlHttpRequest"}}}}}]),t;var s,a,c}());t.View=h,t.Model=l,t.Transition=o,t.default=v,Object.defineProperty(t,"__esModule",{value:!0})});
